import {PostDirektService} from '../src/post-direkt-service.js';

describe('PostDirektService', () => {

    let service;
    let originalFetch;

    beforeEach(() => {
        service = new PostDirektService();
        originalFetch = window.fetch;
    });

    afterEach(() => {
        service.dispose();
        window.fetch = originalFetch;
    });

    it('should return a city on a given zip code', (done) => {
        const testData = `{"finda":"city","searchString":"97074 Würzburg","count":2,"header":{"0":{"col":"plz","label":"PLZ","sortable":true},"1":{"col":"city","label":"Ortsname","sortable":true},"2":{"col":"district","label":"Ortsteil","sortable":true},"3":{"col":"districtlink","label":"","sortable":false},"4":{"col":"streetlink","label":"","sortable":false},"5":{"col":"map","label":"","sortable":false}},"rows":[{"districtlink":false,"city":"Würzburg","district":"Frauenland","streetlink":true,"map":false,"plz":"97074"},{"districtlink":false,"city":"Würzburg","district":"Sanderau","streetlink":true,"map":false,"plz":"97074"}],"city":"Würzburg","switchTo":"","success":true}`;
        const response = new Response(testData, {status: 200});
        spyOn(window, 'fetch').and.returnValue(Promise.resolve(response));
        service.getCities('97074')
            .then(cities => {
                expect(cities).toBeDefined();
                expect(cities.length).toBe(1);
                expect(cities[0]).toBe('Würzburg');
                done();
            })
            .catch(error => fail(error));
    });

    it('should return streets on given zip code and city', (done) => {
        const testData = `{"finda":"streets","searchString":"97074 Würzburg","count":158,"header":{"0":{"col":"plz","label":"PLZ","sortable":true},"1":{"col":"city","label":"Ortsname","sortable":true},"2":{"col":"district","label":"Ortsteil","sortable":true},"3":{"col":"street","label":"Straße","sortable":true},"4":{"col":"number","label":"Nummer","sortable":true},"5":{"col":"map","label":"","sortable":false}},"rows":[{"number":"alle","city":"Würzburg","street":"Abtsleitenweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Agnes-Sapper-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Alandsgrund","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Albert-Hoffa-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Alte Fernstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Am Alten Flugfeld","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Am Galgenberg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Am Hubland","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Am Kugelfang","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Am Terrassenpark","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"An der Sternwarte","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Anton-Bruckner-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Armin-Knab-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Athanasius-Kircher-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"August-Sperl-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Barbarastr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Beatrice-Edgell-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Behrstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Bodelschwinghstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Boßletstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Brettreichstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Cronthalstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Damaschkestr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Dr.-Georg-Fuchs-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Ebertsklinge","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Edelstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Eisenhoferstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Eisenmannstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Elferweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Elisabeth-Scheuring-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Emil-Fischer-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Emil-Hilb-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Emy-Roeder-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Erthalstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Ferdinand-Tietz-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Fichtestr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Franz-Brentano-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Franz-Liszt-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Franz-Schubert-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Franz-Stadelmayer-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Frauenlandplatz","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Frauenlandstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Friedrich-Fick-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Friesstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Fröbelstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Gegenbaurstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Georg-Sittig-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Gerbrunner Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Gerda-Laufer-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Gertrud-von-le-Fort-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Gneisenaustr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Grasweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Greisingstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Gutental","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Göbelslehenstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Hackstetterstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Hans-Löffler-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Haydnstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Heimgartenweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Heiner-Dikreiter-Weg","district":"Sanderau","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Henlestr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Hermann-Schell-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Hermann-Zilcher-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Hofmeierstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Holzbühlweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Hubertistr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Hublandplatz","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Händelstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Ilse-Totzke-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Jakob-Riedinger-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Johannes-Kepler-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"John-Skilton-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Josef-Kentenich-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Josef-Martin-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Kantstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Karl-Ritter-von-Frisch-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Keesburgstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Kettelerstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Kirchbühlstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Kittelstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Klara-Oppenheimer-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Landsteinerstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Lange Bögen","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Lehnleitenweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Leighton-Barracks","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Leightonstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Lendnerstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Leo-Weismantel-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Lerchenhain","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Lerchenweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Leubestr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Lortzingstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Magdalene-Schoch-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Mariannhillstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Matthias-Ehrenfried-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Matthias-Lexer-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Maurmeierstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Max-Heim-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Max-Reger-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Methfesselstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Meyer-Olbersleben-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Mittlerer Neubergweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Mozartstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Mönchbergstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Nachtigallenweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Nopitschstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Norbert-Glanzberg-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Oberer Bogenweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Oberer Neubergweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Oswald-Külpe-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Otto-Nagler-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Otto-Richter-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Parsevalstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Peter-Schneider-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"72 - 998 (gerade)","city":"Würzburg","street":"Randersackerer Str.","district":"Sanderau","map":true,"plz":"97074"},{"number":"81 - 999 (ungerade)","city":"Würzburg","street":"Randersackerer Str.","district":"Sanderau","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Richard-Strauß-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Richard-Wagner-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"14 - 998 (gerade)","city":"Würzburg","street":"Rottendorfer Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"15a - 999 (ungerade)","city":"Würzburg","street":"Rottendorfer Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Salvatorstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Sandbergerstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Sanderheinrichsleitenweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Sanderrothstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Schadewitzstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Schanzstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Schellingstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Schlörstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Sebastian-Merkle-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Seinsheimstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Seuffertstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Silcherstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Simon-Breu-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Skyline-Hill-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Sodenstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Stegerwaldstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Steidlestr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Sterenstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Steubenstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Stöhrstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Theodor-Boveri-Weg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Trautenauer Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Ulrichstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Unterer Neubergweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Voglerstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Von-Luxburg-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Walther-von-der-Vogelweide-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Waltherstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Washington Street","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Wittelsbacherplatz","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Wittelsbacherstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Zeppelinstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Zu-Rhein-Str.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Zweierweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Zwerchgraben","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Zürnstr.","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Äußerer Neubergweg","district":"Frauenland","map":true,"plz":"97074"},{"number":"alle","city":"Würzburg","street":"Äußerer Tränkeweg","district":"Frauenland","map":true,"plz":"97074"}],"city":"Würzburg","district":null,"switchTo":"","success":true}`;
        const response = new Response(testData, {status: 200});
        spyOn(window, 'fetch').and.returnValue(Promise.resolve(response));
        service.getStreets('97074', 'Würzburg')
            .then(streets => {
                expect(streets).toBeDefined();
                expect(streets).toContain('Gneisenaustr.');
                done();
            })
            .catch(error => fail(error));
    });

    it('should create correct request URLs', () => {
        let url = service._citiesRequestUrl('97074');
        let expected = service.baseUrl + '?finda=city&city=97074&lang=de_DE';
        expect(url).toBe(expected);
        url = service._streetsRequestUrl('97074', 'Würzburg');
        expected = service.baseUrl + '?finda=streets&plz_plz=97074&plz_city=W%C3%BCrzburg&lang=de_DE';
        expect(url).toBe(expected);
    });

    it('should have a working cache', () => {
        const list = ['Just', 'a', 'test'];
        service._cache('test', list);
        const cached = service._cached('test');
        expect(cached).toEqual(list);
    });

    it('should cache cities queries', (done) => {
        sessionStorage.clear();
        service.getCities('97074')
            .then(() => {
                service.getCities('97074')
                    .then(cities => {
                        expect(cities).toBeTruthy();
                        expect(cities.length).toBe(1);
                        expect(cities).toContain('Würzburg');
                        expect(sessionStorage.length).toBe(1);
                        done();
                    });
            })
            .catch(error => fail(error));
    });

    it('should cache streets queries', (done) => {
        sessionStorage.clear();
        service.getStreets('97074', 'Würzburg')
            .then(() => {
                service.getStreets('97074', 'Würzburg')
                    .then(streets => {
                        expect(streets).toBeTruthy();
                        expect(streets.length).toBeGreaterThan(1);
                        expect(streets).toContain('Gneisenaustr.');
                        expect(sessionStorage.length).toBe(1);
                        done();
                    });
            })
            .catch(error => fail(error));
    });

    it('should clear session storage after dispose', (done) => {
        service.getCities('97074')
            .then(() => {
                service.dispose();
                expect(sessionStorage.length).toBe(0);
                done();
            })
            .catch(error => fail(error));

    });
});
